---
- name: Include variables
  include_vars:
    file: 'vars/{{stage}}.yaml'

- name: Ensure the repository cloned
  git:
    repo: 'https://github.com/cp-20/read-stack'
    dest: '/srv/read-stack'
    clone: yes
    update: yes
    force: yes

- name: Copy the .env file
  template:
    src: 'env.j2'
    dest: '/srv/read-stack/.env'

- name: Start supabase
  shell: pnpm supabase start-supabase
  args:
    chdir: '/srv/read-stack'
  when: stage == 'dev'

- name: Start the application
  shell: docker compose --env-file=.env up --build -d
  args:
    chdir: '/srv/read-stack'
